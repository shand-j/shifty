# Shifty Platform - Developer Guide

## ðŸŽ¯ Complete Local Development Setup

This guide provides comprehensive instructions for setting up and running the Shifty AI-powered testing platform locally.

## Table of Contents

1. [Quick Setup](#quick-setup)
2. [Manual Setup](#manual-setup) 
3. [Development Workflow](#development-workflow)
4. [Testing & Validation](#testing--validation)
5. [Troubleshooting](#troubleshooting)
6. [System Architecture](#system-architecture)

## Quick Setup

### One-Command Installation

```bash
# Clone the repository
git clone <your-repo-url>
cd shifty

# Run automated setup (recommended)
npm run setup

# Start development environment
npm start

# Validate system
npm run validate
```

**What the setup script does:**
- âœ… Installs Node.js, PostgreSQL, Redis, Ollama via Homebrew
- âœ… Creates PostgreSQL databases and user accounts
- âœ… Downloads AI models (llama3.1:8b, codellama:7b)  
- âœ… Installs all npm dependencies and builds packages
- âœ… Initializes database schema
- âœ… Creates environment configuration
- âœ… Validates system setup

## Manual Setup

### System Requirements

- **macOS** (with Homebrew)
- **8GB+ RAM** (for AI models)
- **Node.js 18+** 
- **PostgreSQL 14+**
- **Redis**
- **Ollama**

### Step-by-Step Installation

#### 1. Install System Dependencies

```bash
# Install Homebrew (if not installed)
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# Install required packages
brew install node postgresql@14 redis ollama
```

#### 2. Configure PostgreSQL

```bash
# Start PostgreSQL service
brew services start postgresql@14

# Create postgres user with password
createuser -s postgres
psql postgres -c "ALTER USER postgres PASSWORD 'postgres';"

# Create Shifty databases
createdb shifty_platform
createdb shifty

# Initialize database schema
psql shifty_platform -f infrastructure/docker/init-platform-db.sql
```

#### 3. Configure Redis

```bash
# Start Redis service
brew services start redis

# Test Redis connection
redis-cli ping  # Should return "PONG"
```

#### 4. Configure Ollama (AI Models)

```bash
# Start Ollama service
brew services start ollama

# Download required AI models (this may take 10-15 minutes)
ollama pull llama3.1:8b
ollama pull codellama:7b

# Verify models
ollama list
```

#### 5. Setup Project

```bash
# Install dependencies
npm install

# Build all packages and services
npm run build

# Create environment configuration
cp .env.example .env.local  # Edit as needed
```

## Development Workflow

### Starting Development Environment

```bash
# Quick start (recommended for daily use)
npm start
# OR
./scripts/dev.sh

# Manual start (all services)
npm run dev

# Individual services (for debugging)
npm run dev:auth-service      # Port 3002
npm run dev:test-generator    # Port 3004  
npm run dev:healing-engine    # Port 3005
npm run dev:api-gateway       # Port 3000
npm run dev:tenant-manager    # Port 3001
npm run dev:ai-orchestrator   # Port 3003
```

### Service URLs

- **API Gateway**: http://localhost:3000 (Entry point)
- **Tenant Manager**: http://localhost:3001
- **Auth Service**: http://localhost:3002  
- **AI Orchestrator**: http://localhost:3003
- **Test Generator**: http://localhost:3004
- **Healing Engine**: http://localhost:3005

### Environment Variables

The system uses these environment variables (auto-generated by setup):

```bash
# Database Configuration
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/shifty_platform
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres

# Redis Configuration  
REDIS_URL=redis://localhost:6379

# JWT Configuration
JWT_SECRET=<auto-generated-secret>

# AI Configuration
OLLAMA_URL=http://localhost:11434
OLLAMA_MODEL=llama3.1:8b
```

## Testing & Validation

### System Health Check

```bash
# Comprehensive system validation
npm run validate
# OR
./scripts/validate-system.sh
```

### Manual Testing

```bash
# Test API Gateway and service discovery
curl http://localhost:3000/health

# Test individual services
curl http://localhost:3002/health  # Auth Service
curl http://localhost:3004/health  # Test Generator
curl http://localhost:3005/health  # Healing Engine

# Test user registration (creates tenant automatically)
curl -X POST http://localhost:3002/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "developer@shifty.com",
    "password": "password123", 
    "firstName": "Developer",
    "lastName": "User", 
    "tenantName": "Development Company"
  }'
```

### Expected Responses

**Health Check Response:**
```json
{
  "status": "healthy",
  "service": "api-gateway", 
  "timestamp": "2025-10-10T...",
  "services": [
    {"service": "/api/v1/tenants", "status": "healthy", "target": "http://localhost:3001"},
    {"service": "/api/v1/auth", "status": "healthy", "target": "http://localhost:3002"},
    // ... more services
  ]
}
```

**Registration Response:**
```json
{
  "user": {
    "id": "uuid",
    "email": "developer@shifty.com",
    "role": "owner"
  },
  "token": "jwt_token_here",
  "tenant": {
    "id": "uuid", 
    "name": "Development Company",
    "slug": "development-company",
    "plan": "starter",
    "status": "active"
  }
}
```

## Troubleshooting

### Common Issues

#### PostgreSQL Connection Issues

**Error**: `ECONNREFUSED ::1:5432`

**Solution**:
```bash
brew services restart postgresql@14
createuser -s postgres 2>/dev/null || true  
psql postgres -c "ALTER USER postgres PASSWORD 'postgres';"
```

#### Redis Connection Issues

**Error**: Redis connection failed

**Solution**:
```bash
brew services restart redis
redis-cli ping  # Should return "PONG"
```

#### Ollama Model Issues

**Error**: AI models not found

**Solution**:
```bash
brew services restart ollama
ollama pull llama3.1:8b
ollama pull codellama:7b
```

#### Port Conflicts

**Error**: `EADDRINUSE: address already in use`

**Solution**:
```bash
# Kill processes using development ports
lsof -ti:3000,3001,3002,3003,3004,3005 | xargs kill -9 2>/dev/null || true

# Or restart specific services
npm run dev
```

#### Build Issues

**Error**: TypeScript compilation errors

**Solution**:
```bash
# Clean and rebuild
npm run clean
rm -rf node_modules package-lock.json
npm install
npm run build
```

### Emergency Reset

If the system becomes completely unstable:

```bash
# Stop all services
brew services stop postgresql@14 redis ollama

# Clean project completely
npm run clean
rm -rf node_modules package-lock.json

# Run complete setup again
npm run setup
```

### Getting Help

1. **Check system status**: `npm run validate`
2. **Review service logs**: Individual service terminals show detailed error messages
3. **Check database**: `psql shifty_platform -c "SELECT * FROM tenants;"`
4. **Verify AI models**: `ollama list`

## System Architecture

### Services Overview

| Service | Port | Purpose | Dependencies |
|---------|------|---------|--------------|
| API Gateway | 3000 | Service discovery, rate limiting | Redis |
| Tenant Manager | 3001 | Multi-tenant provisioning | PostgreSQL |
| Auth Service | 3002 | JWT authentication, user management | PostgreSQL |
| AI Orchestrator | 3003 | AI coordination, model management | Ollama |
| Test Generator | 3004 | AI-powered test creation | Ollama, PostgreSQL |
| Healing Engine | 3005 | Selector healing strategies | Ollama |

### Technology Stack

- **Runtime**: Node.js 18+ with TypeScript
- **Frameworks**: Fastify (microservices), Express (some services)
- **Database**: PostgreSQL 14+ (multi-tenant architecture)
- **Caching**: Redis
- **AI/ML**: Ollama with Llama 3.1 and CodeLlama models
- **Build System**: Turbo monorepo
- **Process Management**: npm scripts, nodemon

### Development Tips

1. **Use the validation script regularly**: `npm run validate`
2. **Start services individually for debugging**: `npm run dev:service-name`
3. **Check health endpoints first**: `curl http://localhost:PORT/health`
4. **Monitor service logs**: Each service shows detailed logging in development
5. **Database inspection**: Use `psql shifty_platform` to inspect data

---

## ðŸŽ‰ Success!

If you've completed this setup, you now have:
- âœ… Full Shifty platform running locally
- âœ… All 6 microservices operational  
- âœ… AI models ready for test generation
- âœ… Multi-tenant database configured
- âœ… Complete development environment

**Next Steps:**
- Explore the API endpoints
- Try the AI-powered test generation
- Build frontend integrations
- Contribute to the codebase

Happy coding! ðŸš€