# Developer QE Playbook

## Overview

As a Developer, your goal is effortless testing with hyper-fast feedback. This playbook shows you how to integrate Shifty's SDK, leverage test generation, and maintain healthy CI pipelines.

## Quick Start

### SDK Installation

```bash
# Core SDK
npm install @shifty/sdk-core @shifty/sdk-playwright

# For production monitoring
npm install @shifty/sdk-observability
```

### Configuration

```typescript
// shifty.config.ts
import { ShiftyConfig } from '@shifty/sdk-core';

export const shiftyConfig: ShiftyConfig = {
  tenantId: process.env.SHIFTY_TENANT_ID!,
  apiKey: process.env.SHIFTY_API_KEY!,
  environment: process.env.NODE_ENV,
  telemetry: {
    enabled: true,
    serviceName: 'my-service',
    autoInstrument: true,
  },
  testing: {
    autoHeal: true,
    generateOnGap: true,
    healingConfidence: 0.8,
  },
};
```

### Basic Usage

```typescript
import { ShiftyClient } from '@shifty/sdk-core';

const shifty = new ShiftyClient(shiftyConfig);

// Track test quality events
await shifty.track('test.executed', {
  testName: 'checkout-flow',
  result: 'passed',
  duration: 1234,
});
```

## Test Generation

### Automatic Generation

When coverage gaps are detected:

```http
POST /api/v1/ci/actions/test-gen
{
  "repo": "org/repo",
  "commitSha": "abc123",
  "coverageGaps": [
    {"file": "src/Cart.tsx", "coverage": 45, "uncoveredLines": [15, 23, 45]}
  ],
  "options": {
    "framework": "playwright",
    "style": "behavior-driven"
  }
}
```

### Generated Test Example

```typescript
// Generated by Shifty
import { shiftyTest, expect } from '@shifty/sdk-playwright';

shiftyTest.describe('Cart Component', () => {
  shiftyTest('should update quantity when +/- clicked', async ({ page, shifty }) => {
    await page.goto('/cart');
    
    const initialQty = await page.locator('[data-testid="quantity"]').textContent();
    await shifty.click('[data-testid="increase-qty"]');
    
    await expect(page.locator('[data-testid="quantity"]')).toHaveText(
      String(Number(initialQty) + 1)
    );
  });
});
```

### CLI Generation

```bash
# Generate tests for specific file
npx shifty generate --file src/components/Cart.tsx

# Generate for entire directory
npx shifty generate --dir src/components --coverage-threshold 80
```

## Test Healing

### How It Works

1. Test fails due to selector change
2. Shifty captures DOM snapshot and screenshot
3. AI analyzes and suggests new selector
4. Developer approves or modifies
5. Test is automatically updated

### Healing Configuration

```typescript
// playwright.config.ts
export default {
  healing: {
    enabled: true,
    strategies: ['visual', 'structural', 'semantic'],
    confidence: 0.8,
    autoApprove: false, // Require manual approval
    fallbackTimeout: 5000,
  },
};
```

### Manual Healing Review

```http
GET /api/v1/healing/suggestions?status=pending
```

Response:
```json
{
  "suggestions": [{
    "id": "heal-123",
    "testFile": "cart.spec.ts",
    "oldSelector": "[data-testid='pay']",
    "newSelector": "[data-testid='pay-button']",
    "confidence": 0.92,
    "evidence": {
      "visualMatch": true,
      "structuralMatch": true,
      "semanticMatch": true
    }
  }]
}
```

### Approve Healing

```http
POST /api/v1/healing/suggestions/heal-123/approve
{
  "autoUpdate": true,
  "createPR": false
}
```

## CI Pipeline Integration

### GitHub Actions Setup

```yaml
# .github/workflows/test.yml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Tests with Shifty
        env:
          SHIFTY_API_KEY: ${{ secrets.SHIFTY_API_KEY }}
          SHIFTY_TENANT_ID: ${{ secrets.SHIFTY_TENANT_ID }}
        run: |
          npm ci
          npx playwright test
          
      - name: Upload Results to Shifty
        if: always()
        run: npx shifty upload-results
```

### Quality Gate Check

```yaml
- name: Check Quality Gate
  uses: shifty/quality-gate-action@v1
  with:
    api-key: ${{ secrets.SHIFTY_API_KEY }}
    fail-on: coverage-decrease, new-bugs
```

### Pipeline Health Monitoring

```http
GET /api/v1/ci/pipelines/{pipelineId}/health
```

Response:
```json
{
  "health": "warning",
  "metrics": {
    "successRate": 85,
    "avgDuration": 342000,
    "flakiness": 12,
    "failurePatterns": [
      {"type": "timeout", "frequency": 5},
      {"type": "selector-changed", "frequency": 3}
    ]
  },
  "recommendations": [
    "Consider healing 3 flaky selectors",
    "Increase timeout for network-heavy tests"
  ]
}
```

## Telemetry Integration

### Production Monitoring

```typescript
import { ShiftyObservability } from '@shifty/sdk-observability';

const obs = new ShiftyObservability({
  serviceName: 'my-api',
  environment: 'production',
});

// Auto-instrument Express
obs.instrumentExpress(app);

// Custom spans
const span = obs.startSpan('process-order');
try {
  await processOrder(orderId);
  span.setStatus({ code: SpanStatusCode.OK });
} catch (error) {
  span.setStatus({ code: SpanStatusCode.ERROR, message: error.message });
  throw error;
} finally {
  span.end();
}
```

### Error Correlation

```typescript
// Errors automatically correlated with test failures
obs.captureError(error, {
  context: 'checkout',
  orderId: '12345',
  testIds: ['checkout-001', 'checkout-002'], // Related tests
});
```

## Local Development

### Pre-commit Hooks

```json
// package.json
{
  "husky": {
    "hooks": {
      "pre-commit": "npx shifty check --staged"
    }
  }
}
```

### VS Code Extension

Install the Shifty VS Code extension for:
- Inline test suggestions
- Coverage visualization
- Quick test generation
- Healing notifications

### Watch Mode

```bash
# Run tests in watch mode with healing
npx playwright test --watch --shifty-heal
```

## Debugging Failed Tests

### Get Failure Context

```http
GET /api/v1/tests/{testId}/failures/{runId}
```

Response includes:
- Full stack trace
- DOM snapshot
- Network logs
- Screenshot
- Related code changes
- Similar past failures

### AI Analysis

```http
POST /api/v1/tests/analyze-failure
{
  "error": "timeout waiting for selector",
  "selector": "[data-testid='submit']",
  "screenshot": "base64...",
  "domSnapshot": "<html>..."
}
```

Response:
```json
{
  "analysis": {
    "rootCause": "selector-changed",
    "confidence": 0.94,
    "suggestedFix": "Selector changed to [data-testid='submit-button']",
    "relatedCommit": "abc123",
    "developer": "developer@example.com"
  }
}
```

## Best Practices

### 1. Test Organization

```
tests/
├── unit/           # Fast, isolated
├── integration/    # API/service tests
├── e2e/            # Full workflow tests
│   ├── critical/   # Smoke tests
│   └── regression/ # Full regression
└── visual/         # Screenshot tests
```

### 2. Selector Strategy

```typescript
// ✅ Good - stable, semantic
page.getByRole('button', { name: 'Submit' })
page.getByTestId('checkout-button')

// ❌ Avoid - brittle
page.locator('div > div > button:nth-child(2)')
page.locator('.btn-primary')
```

### 3. Test Data

```typescript
// Use factories for test data
import { createTestUser, createTestProduct } from '@/test/factories';

shiftyTest('checkout with new user', async ({ page }) => {
  const user = await createTestUser();
  const product = await createTestProduct({ price: 99.99 });
  // ...
});
```

### 4. Parallelization

```typescript
// playwright.config.ts
export default {
  workers: process.env.CI ? 4 : 1,
  fullyParallel: true,
  retries: process.env.CI ? 2 : 0,
};
```

### 5. Test Isolation

```typescript
shiftyTest.beforeEach(async ({ page }) => {
  // Reset state before each test
  await page.evaluate(() => localStorage.clear());
  await resetDatabase();
});
```

## Metrics Dashboard

### Developer-Specific Metrics

```http
GET /api/v1/roi/developer/{developerId}/metrics
```

Key metrics:
- **Test Velocity**: Tests added per sprint
- **Coverage Delta**: Coverage change per PR
- **Flaky Contributions**: Flaky tests introduced
- **Healing Approvals**: Healing suggestions actioned

### Code Quality Correlation

```http
GET /api/v1/quality/correlation?repo={repo}&file={file}
```

Shows:
- Bug rate vs. test coverage
- Churn rate vs. defects
- Complexity vs. failures

## Success Criteria

| Metric | Target | Measurement |
|--------|--------|-------------|
| Test Coverage | > 80% | Lines covered |
| CI Pass Rate | > 95% | Green builds |
| Time to Green | < 10 min | PR to green |
| Healing Acceptance | > 90% | Auto-healed tests |
| Test Flakiness | < 5% | Inconsistent tests |
