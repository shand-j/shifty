# Shifty Multi-Tenant SaaS Platform
# Docker Compose for development environment

services:
  # Platform PostgreSQL Database
  platform-db:
    image: postgres:15-alpine
    container_name: shifty-platform-db
    environment:
      POSTGRES_DB: shifty_platform
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - platform_db_data:/var/lib/postgresql/data
      - ./infrastructure/docker/init-platform-db.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - shifty-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for caching and queues
  redis:
    image: redis:7-alpine
    container_name: shifty-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - shifty-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Ollama AI Service
  ollama:
    image: ollama/ollama:latest
    container_name: shifty-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_models:/root/.ollama
    environment:
      - OLLAMA_MODELS=/root/.ollama/models
    networks:
      - shifty-network
    # GPU acceleration is optional. Remove the comment markers below and
    # set COMPOSE_PROFILES=gpu if you want to reserve an NVIDIA device.
    #profiles:
    #  - gpu
    #deploy:
    #  resources:
    #    reservations:
    #      devices:
    #        - driver: nvidia
    #          count: 1
    #          capabilities: [gpu]

  # Tenant Manager Service
  tenant-manager:
    build:
      context: .
      dockerfile: services/Dockerfile.service
      args:
        SERVICE_PATH: services/tenant-manager
        PACKAGE_NAME: "@shifty/tenant-manager"
    container_name: shifty-tenant-manager
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=development
      - PORT=3001
      - DATABASE_URL=postgresql://postgres:postgres@platform-db:5432/shifty_platform
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET:-dev-secret-key-change-in-production}
    depends_on:
      platform-db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - shifty-network

  # Auth Service
  auth-service:
    build:
      context: .
      dockerfile: services/Dockerfile.service
      args:
        SERVICE_PATH: services/auth-service
        PACKAGE_NAME: "@shifty/auth-service"
    container_name: shifty-auth-service
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=development
      - PORT=3002
      - DATABASE_URL=postgresql://postgres:postgres@platform-db:5432/shifty_platform
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET:-dev-secret-key-change-in-production}
    depends_on:
      platform-db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - shifty-network

  # AI Orchestrator Service
  ai-orchestrator:
    build:
      context: .
      dockerfile: services/Dockerfile.service
      args:
        SERVICE_PATH: services/ai-orchestrator
        PACKAGE_NAME: "@shifty/ai-orchestrator"
    container_name: shifty-ai-orchestrator
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=development
      - PORT=3003
      - DATABASE_URL=postgresql://postgres:postgres@platform-db:5432/shifty_platform
      - OLLAMA_ENDPOINT=http://ollama:11434
      - REDIS_URL=redis://redis:6379
    depends_on:
      platform-db:
        condition: service_healthy
      redis:
        condition: service_healthy
      ollama:
        condition: service_started
    networks:
      - shifty-network

  # Test Generator Service (Port 3004)
  test-generator:
    build:
      context: .
      dockerfile: services/Dockerfile.service
      args:
        SERVICE_PATH: services/test-generator
        PACKAGE_NAME: "@shifty/test-generator"
    container_name: shifty-test-generator
    ports:
      - "3004:3004"
    environment:
      - NODE_ENV=development
      - PORT=3004
      - DATABASE_URL=postgresql://postgres:postgres@platform-db:5432/shifty_platform
      - OLLAMA_URL=http://ollama:11434
      - AI_MODEL=llama3.1
      - JWT_SECRET=${JWT_SECRET:-dev-secret-key-change-in-production}
    depends_on:
      platform-db:
        condition: service_healthy
      ollama:
        condition: service_started
    networks:
      - shifty-network

  # Healing Engine Service
  healing-engine:
    build:
      context: .
      dockerfile: services/Dockerfile.service
      args:
        SERVICE_PATH: services/healing-engine
        PACKAGE_NAME: "@shifty/healing-engine"
    container_name: shifty-healing-engine
    ports:
      - "3005:3005"
    environment:
      - NODE_ENV=development
      - PORT=3005
      - DATABASE_URL=postgresql://postgres:postgres@platform-db:5432/shifty_platform
      - OLLAMA_URL=http://ollama:11434
      - AI_MODEL=llama3.1
      - JWT_SECRET=${JWT_SECRET:-dev-secret-key-change-in-production}
    depends_on:
      platform-db:
        condition: service_healthy
      ollama:
        condition: service_started
    networks:
      - shifty-network

  # API Gateway (Single definition - removed duplicate)
  # API Gateway
  # Central routing service that proxies requests to all backend services
  # Service URLs reference other services defined elsewhere in this file (order doesn't matter for docker-compose)
  api-gateway:
    build:
      context: .
      dockerfile: apps/api-gateway/Dockerfile
    container_name: shifty-api-gateway
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - PORT=3000
      - MOCK_MODE=true
      # Core services
      - TENANT_MANAGER_URL=http://tenant-manager:3001
      - AUTH_SERVICE_URL=http://auth-service:3002
      - AI_ORCHESTRATOR_URL=http://ai-orchestrator:3003
      - TEST_GENERATOR_URL=http://test-generator:3004
      - HEALING_ENGINE_URL=http://healing-engine:3005
      # Testing modalities
      - ROI_SERVICE_URL=http://roi-service:3015
      - PERFORMANCE_TESTING_URL=http://performance-testing:3016
      - SECURITY_TESTING_URL=http://security-testing:3017
      - ACCESSIBILITY_TESTING_URL=http://accessibility-testing:3018
      # Collaboration & orchestration
      - MANUAL_SESSION_HUB_URL=http://manual-session-hub:3019
      - HITL_ARCADE_URL=http://hitl-arcade:3011
      - CICD_GOVERNOR_URL=http://cicd-governor:3012
      # Security
      - JWT_SECRET=${JWT_SECRET:-dev-secret-key-change-in-production}
      - REDIS_URL=redis://redis:6379
    depends_on:
      redis:
        condition: service_healthy
      auth-service:
        condition: service_started
      tenant-manager:
        condition: service_started
      ai-orchestrator:
        condition: service_started
      test-generator:
        condition: service_started
      healing-engine:
        condition: service_started
      roi-service:
        condition: service_started
      performance-testing:
        condition: service_started
      security-testing:
        condition: service_started
      accessibility-testing:
        condition: service_started
      manual-session-hub:
        condition: service_started
      hitl-arcade:
        condition: service_started
      cicd-governor:
        condition: service_started
    networks:
      - shifty-network

  # GPU Provisioner Service
  gpu-provisioner:
    build:
      context: .
      dockerfile: services/Dockerfile.service
      args:
        SERVICE_PATH: services/gpu-provisioner
        PACKAGE_NAME: "@shifty/gpu-provisioner"
    container_name: shifty-gpu-provisioner
    ports:
      - "3007:3007"
    environment:
      - NODE_ENV=development
      - PORT=3007
      - DATABASE_URL=postgresql://postgres:postgres@platform-db:5432/shifty_platform
      - VASTAI_API_KEY=${VASTAI_API_KEY:-}
      - SHIFTY_INTERNAL_API_KEY=${SHIFTY_INTERNAL_API_KEY:-dev-internal-key}
    depends_on:
      platform-db:
        condition: service_healthy
    networks:
      - shifty-network

  # Model Registry Service
  model-registry:
    build:
      context: .
      dockerfile: services/Dockerfile.service
      args:
        SERVICE_PATH: services/model-registry
        PACKAGE_NAME: "@shifty/model-registry"
    container_name: shifty-model-registry
    ports:
      - "3008:3008"
    environment:
      - NODE_ENV=development
      - PORT=3008
      - DATABASE_URL=postgresql://postgres:postgres@platform-db:5432/shifty_platform
      - HUGGINGFACE_API_TOKEN=${HUGGINGFACE_API_TOKEN:-}
      - OLLAMA_ENDPOINT=http://ollama:11434
      - GPU_PROVISIONER_URL=http://gpu-provisioner:3007
      - DATA_LIFECYCLE_URL=http://data-lifecycle:3009
    depends_on:
      platform-db:
        condition: service_healthy
      ollama:
        condition: service_started
      gpu-provisioner:
        condition: service_started
    networks:
      - shifty-network

  # Data Lifecycle Service
  data-lifecycle:
    build:
      context: .
      dockerfile: services/Dockerfile.service
      args:
        SERVICE_PATH: services/data-lifecycle
        PACKAGE_NAME: "@shifty/data-lifecycle"
    container_name: shifty-data-lifecycle
    ports:
      - "3009:3009"
    environment:
      - NODE_ENV=development
      - PORT=3009
      - DATABASE_URL=postgresql://postgres:postgres@platform-db:5432/shifty_platform
    depends_on:
      platform-db:
        condition: service_healthy
    networks:
      - shifty-network

  # HITL Arcade Service
  hitl-arcade:
    build:
      context: .
      dockerfile: services/Dockerfile.service
      args:
        SERVICE_PATH: services/hitl-arcade
        PACKAGE_NAME: "@shifty/hitl-arcade"
    container_name: shifty-hitl-arcade
    ports:
      - "3011:3011"
    environment:
      - NODE_ENV=development
      - PORT=3011
      - DATABASE_URL=postgresql://postgres:postgres@platform-db:5432/shifty_platform
    depends_on:
      platform-db:
        condition: service_healthy
    networks:
      - shifty-network

  # CI/CD Governor Service
  cicd-governor:
    build:
      context: .
      dockerfile: services/Dockerfile.service
      args:
        SERVICE_PATH: services/cicd-governor
        PACKAGE_NAME: "@shifty/cicd-governor"
    container_name: shifty-cicd-governor
    ports:
      - "3012:3012"
    environment:
      - NODE_ENV=development
      - PORT=3012
      - DATABASE_URL=postgresql://postgres:postgres@platform-db:5432/shifty_platform
      - INTEGRATIONS_URL=http://integrations:3014
    depends_on:
      platform-db:
        condition: service_healthy
    networks:
      - shifty-network

  # Production Feedback Service
  production-feedback:
    build:
      context: .
      dockerfile: services/Dockerfile.service
      args:
        SERVICE_PATH: services/production-feedback
        PACKAGE_NAME: "@shifty/production-feedback"
    container_name: shifty-production-feedback
    ports:
      - "3013:3013"
    environment:
      - NODE_ENV=development
      - PORT=3013
      - DATABASE_URL=postgresql://postgres:postgres@platform-db:5432/shifty_platform
      - TEST_GENERATOR_URL=http://test-generator:3004
      - INTEGRATIONS_URL=http://integrations:3014
    depends_on:
      platform-db:
        condition: service_healthy
      test-generator:
        condition: service_started
    networks:
      - shifty-network

  # Integrations Service
  integrations:
    build:
      context: .
      dockerfile: services/Dockerfile.service
      args:
        SERVICE_PATH: services/integrations
        PACKAGE_NAME: "@shifty/integrations"
    container_name: shifty-integrations
    ports:
      - "3014:3014"
    environment:
      - NODE_ENV=development
      - PORT=3014
      - DATABASE_URL=postgresql://postgres:postgres@platform-db:5432/shifty_platform
      - PRODUCTION_FEEDBACK_URL=http://production-feedback:3013
      - WEBHOOK_BASE_URL=${WEBHOOK_BASE_URL:-http://localhost:3014}
    depends_on:
      platform-db:
        condition: service_healthy
    networks:
      - shifty-network

  # ROI Service
  roi-service:
    build:
      context: .
      dockerfile: services/Dockerfile.service
      args:
        SERVICE_PATH: services/roi-service
        PACKAGE_NAME: "@shifty/roi-service"
    container_name: shifty-roi-service
    ports:
      - "3015:3015"
    environment:
      - NODE_ENV=development
      - PORT=3015
      - DATABASE_URL=postgresql://postgres:postgres@platform-db:5432/shifty_platform
    depends_on:
      platform-db:
        condition: service_healthy
    networks:
      - shifty-network

  # Performance Testing Service
  performance-testing:
    build:
      context: .
      dockerfile: services/Dockerfile.service
      args:
        SERVICE_PATH: services/performance-testing
        PACKAGE_NAME: "@shifty/performance-testing"
    container_name: shifty-performance-testing
    ports:
      - "3016:3016"
    environment:
      - NODE_ENV=development
      - PORT=3016
      - DATABASE_URL=postgresql://postgres:postgres@platform-db:5432/shifty_platform
    depends_on:
      platform-db:
        condition: service_healthy
    networks:
      - shifty-network

  # Security Testing Service
  security-testing:
    build:
      context: .
      dockerfile: services/Dockerfile.service
      args:
        SERVICE_PATH: services/security-testing
        PACKAGE_NAME: "@shifty/security-testing"
    container_name: shifty-security-testing
    ports:
      - "3017:3017"
    environment:
      - NODE_ENV=development
      - PORT=3017
      - DATABASE_URL=postgresql://postgres:postgres@platform-db:5432/shifty_platform
    depends_on:
      platform-db:
        condition: service_healthy
    networks:
      - shifty-network

  # Accessibility Testing Service
  accessibility-testing:
    build:
      context: .
      dockerfile: services/Dockerfile.service
      args:
        SERVICE_PATH: services/accessibility-testing
        PACKAGE_NAME: "@shifty/accessibility-testing"
    container_name: shifty-accessibility-testing
    ports:
      - "3018:3018"
    environment:
      - NODE_ENV=development
      - PORT=3018
      - DATABASE_URL=postgresql://postgres:postgres@platform-db:5432/shifty_platform
    depends_on:
      platform-db:
        condition: service_healthy
    networks:
      - shifty-network

  # Manual Session Hub Service
  manual-session-hub:
    build:
      context: .
      dockerfile: services/Dockerfile.service
      args:
        SERVICE_PATH: services/manual-session-hub
        PACKAGE_NAME: "@shifty/manual-session-hub"
    container_name: shifty-manual-session-hub
    ports:
      - "3019:3019"
    environment:
      - NODE_ENV=development
      - PORT=3019
      - DATABASE_URL=postgresql://postgres:postgres@platform-db:5432/shifty_platform
    depends_on:
      platform-db:
        condition: service_healthy
    networks:
      - shifty-network

  # QE Collaborator Service
  qe-collaborator:
    build:
      context: .
      dockerfile: services/Dockerfile.service
      args:
        SERVICE_PATH: services/qe-collaborator
        PACKAGE_NAME: "@shifty/qe-collaborator"
    container_name: shifty-qe-collaborator
    ports:
      - "3020:3020"
    environment:
      - NODE_ENV=development
      - PORT=3020
      - DATABASE_URL=postgresql://postgres:postgres@platform-db:5432/shifty_platform
      - OLLAMA_ENDPOINT=http://ollama:11434
    depends_on:
      platform-db:
        condition: service_healthy
      ollama:
        condition: service_started
    networks:
      - shifty-network

  # Frontend Application (Next.js)
  frontend:
    build:
      context: ./apps/frontend
      dockerfile: Dockerfile
    container_name: shifty-frontend
    ports:
      - "3010:3000"
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=http://api-gateway:3000
      - NEXT_PUBLIC_MOCK_MODE=true
      - NEXT_PUBLIC_WS_URL=ws://api-gateway:3000
      - NEXT_PUBLIC_ENABLE_ARCADE=true
      - NEXT_PUBLIC_ENABLE_KNOWLEDGE=true
      - NEXT_PUBLIC_ENABLE_HITL=true
    depends_on:
      - api-gateway
    networks:
      - shifty-network

volumes:
  platform_db_data:
  redis_data:
  ollama_models:

networks:
  shifty-network:
    driver: bridge
